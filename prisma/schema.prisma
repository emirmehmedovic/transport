generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  DISPATCHER
  DRIVER
}

enum DriverStatus {
  ACTIVE
  VACATION
  SICK_LEAVE
  INACTIVE
}

enum LoadStatus {
  AVAILABLE
  ASSIGNED
  ACCEPTED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum LoadStopType {
  PICKUP
  DELIVERY
  INTERMEDIATE
}

enum LoadCargoType {
  LABUDICA
  CISTERNA
  TERET
}

enum VehicleSize {
  SMALL // sedan, hatchback
  MEDIUM // mid-size SUV
  LARGE // full-size SUV, pickup
  OVERSIZED // lifted trucks, vans
}

enum DocumentType {
  BOL // Bill of Lading
  POD // Proof of Delivery
  DAMAGE_REPORT
  LOAD_PHOTO
  RATE_CONFIRMATION
  FUEL_RECEIPT
  INSPECTION_PHOTO
  INCIDENT_PHOTO
  CDL_LICENSE
  MEDICAL_CARD
  INSURANCE
  REGISTRATION
  OTHER
}

enum MaintenanceType {
  OIL_CHANGE
  TIRE_ROTATION
  BRAKE_SERVICE
  GENERAL_REPAIR
  INSPECTION
  OTHER
}

enum ExpenseType {
  FUEL
  TOLLS
  REPAIRS
  MAINTENANCE
  INSURANCE
  REGISTRATION
  OTHER
}

enum TollPermitType {
  VIGNETTE
  TOLLBOX
  PERMIT
  EMISSION_ZONE
  OTHER
}

enum TollPermitStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum InspectionType {
  PRE_TRIP
  POST_TRIP
}

enum InspectionStatus {
  SAFE
  UNSAFE
  NEEDS_REPAIR
}

enum IncidentSeverity {
  MINOR
  MAJOR
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_REVIEW
  CLOSED
}

enum ClaimStatus {
  OPEN
  APPROVED
  REJECTED
  PAID
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  VOID
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  DOCUMENT_UPLOAD
  ASSIGNMENT
  PAYMENT
}

enum AuditEntity {
  USER
  DRIVER
  TRUCK
  LOAD
  DOCUMENT
  PAY_STUB
  MAINTENANCE
  EXPENSE
}

// Models
model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  role           UserRole @default(DRIVER)
  firstName      String
  lastName       String
  phone          String?
  telegramChatId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver    Driver?
  auditLogs AuditLog[]
  alertAcknowledgements AlertAcknowledgement[] @relation("AlertAcknowledgements")

  @@index([email])
}

model Driver {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  hireDate DateTime
  status   DriverStatus @default(ACTIVE)

  // CDL Info
  cdlNumber    String
  cdlState     String
  cdlExpiry    DateTime
  endorsements String[] // Array of endorsements (H, N, T, etc)

  // Medical & Compliance
  medicalCardExpiry DateTime

  // Emergency Contact
  emergencyContactName  String
  emergencyContactPhone String

  // Financial
  ratePerMile Float @default(0.60)

  // Schengen 90/180 manual override (remaining days as of a date)
  schengenManualRemainingDays Int?
  schengenManualAsOf          DateTime?

  // GPS Tracking
  lastKnownLatitude  Float?
  lastKnownLongitude Float?
  lastLocationUpdate DateTime?

  // Traccar Integration
  traccarDeviceId String? @unique // Device ID for Traccar Client

  // Backup driver relation
  backupForTruck Truck? @relation("BackupDriver")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  primaryTruck           Truck?                  @relation("PrimaryDriver")
  loads                  Load[]
  payStubs               PayStub[]
  vacationPeriods        VacationPeriod[]
  documents              Document[]
  recurringLoadTemplates RecurringLoadTemplate[]
  positions              Position[] // Traccar position history
  geofenceEvents         GeofenceEvent[] // Geofence entry/exit events
  schengenDays           SchengenDay[]
  inspections            Inspection[]
  incidents              Incident[]

  @@index([userId])
  @@index([status])
  @@index([traccarDeviceId])
}

model Truck {
  id String @id @default(cuid())

  // Basic Info
  truckNumber  String @unique
  vin          String @unique
  make         String
  model        String
  year         Int
  licensePlate String

  // Registration & Insurance
  registrationExpiry DateTime
  insuranceProvider  String
  insurancePolicyNo  String
  insuranceExpiry    DateTime

  // Mileage
  currentMileage Int @default(0)

  // Car Hauler Capacity
  maxSmallCars  Int @default(8)
  maxMediumCars Int @default(6)
  maxLargeCars  Int @default(4)
  maxOversized  Int @default(2)

  // Status
  isActive Boolean @default(true)

  // GPS Tracking (NTS International)
  ntsDeviceId String? @unique // Device ID from NTS International GPS system

  // Driver Assignment
  primaryDriverId String? @unique
  primaryDriver   Driver? @relation("PrimaryDriver", fields: [primaryDriverId], references: [id])

  backupDriverId String? @unique
  backupDriver   Driver? @relation("BackupDriver", fields: [backupDriverId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  loads                  Load[]
  maintenanceRecords     MaintenanceRecord[]
  expenses               TruckExpense[]
  recurringLoadTemplates RecurringLoadTemplate[]
  tollPermits            TollPermit[]
  trailers               Trailer[]
  inspections            Inspection[]
  incidents              Incident[]

  @@index([truckNumber])
  @@index([isActive])
}

model Trailer {
  id String @id @default(cuid())

  trailerNumber String @unique
  vin           String? @unique
  make          String?
  model         String?
  year          Int?
  licensePlate  String?

  registrationExpiry DateTime?
  insuranceExpiry    DateTime?

  isActive Boolean @default(true)
  currentMileage Int @default(0)

  currentTruckId String?
  currentTruck   Truck? @relation(fields: [currentTruckId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inspections Inspection[]
  incidents   Incident[]

  @@index([trailerNumber])
  @@index([currentTruckId])
}

model Inspection {
  id String @id @default(cuid())

  type   InspectionType
  status InspectionStatus
  checklist Json?

  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  truckId String
  truck   Truck  @relation(fields: [truckId], references: [id], onDelete: Cascade)

  trailerId String?
  trailer   Trailer? @relation(fields: [trailerId], references: [id], onDelete: SetNull)

  odometer Int?
  defects  Boolean @default(false)
  defectNotes String? @db.Text
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents Document[]

  @@index([driverId])
  @@index([truckId])
  @@index([trailerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Incident {
  id String @id @default(cuid())

  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  truckId String
  truck   Truck  @relation(fields: [truckId], references: [id], onDelete: Cascade)

  trailerId String?
  trailer   Trailer? @relation(fields: [trailerId], references: [id], onDelete: SetNull)

  loadId String?
  load   Load? @relation(fields: [loadId], references: [id], onDelete: SetNull)

  occurredAt DateTime
  location   String
  description String @db.Text
  severity IncidentSeverity @default(MINOR)
  status   IncidentStatus @default(OPEN)

  claims Claim[]
  documents Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([truckId])
  @@index([trailerId])
  @@index([loadId])
  @@index([status])
  @@index([severity])
  @@index([occurredAt])
}

model Claim {
  id String @id @default(cuid())

  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  claimNumber String? @unique
  amount Float? @default(0)
  status ClaimStatus @default(OPEN)
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([incidentId])
  @@index([status])
}

model Customer {
  id String @id @default(cuid())

  name  String
  email String?
  phone String?
  vatNumber String?
  address String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]

  @@index([name])
}

model Invoice {
  id String @id @default(cuid())

  invoiceNumber String @unique
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  issueDate DateTime
  dueDate   DateTime
  status    InvoiceStatus @default(DRAFT)
  currency  String @default("EUR")
  totalAmount Float @default(0)
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines InvoiceLine[]

  @@index([invoiceNumber])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceLine {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Int @default(1)
  unitPrice   Float @default(0)
  lineTotal   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
}

model TollPermit {
  id String @id @default(cuid())

  truckId String
  truck   Truck  @relation(fields: [truckId], references: [id], onDelete: Cascade)

  countryCode String
  countryName String?

  type   TollPermitType
  status TollPermitStatus @default(ACTIVE)

  provider    String?
  referenceNo String?
  validFrom   DateTime
  validTo     DateTime
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([truckId])
  @@index([countryCode])
  @@index([type])
  @@index([status])
  @@index([validTo])
}

model Load {
  id         String @id @default(cuid())
  loadNumber String @unique
  routeName  String?
  cargoType  LoadCargoType @default(TERET)

  // Assignment
  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  truckId String?
  truck   Truck?  @relation(fields: [truckId], references: [id])

  // Status
  status LoadStatus @default(AVAILABLE)
  assignedAt   DateTime?
  inTransitAt  DateTime?
  completedAt  DateTime?

  // Pickup Details
  pickupAddress       String
  pickupCity          String
  pickupState         String
  pickupZip           String
  pickupLatitude      Float?
  pickupLongitude     Float?
  pickupContactName   String
  pickupContactPhone  String
  scheduledPickupDate DateTime
  actualPickupDate    DateTime?

  // Delivery Details
  deliveryAddress       String
  deliveryCity          String
  deliveryState         String
  deliveryZip           String
  deliveryLatitude      Float?
  deliveryLongitude     Float?
  deliveryContactName   String
  deliveryContactPhone  String
  scheduledDeliveryDate DateTime
  actualDeliveryDate    DateTime?

  // Load Details
  distance          Int // loaded miles
  deadheadMiles     Int    @default(0)
  loadRate          Float
  customRatePerMile Float? // override default driver rate
  detentionTime     Int? // hours
  detentionPay      Float? @default(0)
  estimatedDurationHours Float?

  // Notes
  notes               String? @db.Text
  specialInstructions String? @db.Text

  // Recurring
  isRecurring      Boolean @default(false)
  recurringGroupId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicles  Vehicle[]
  cargoItems LoadCargoItem[]
  documents Document[]
  stops     LoadStop[]
  incidents Incident[]

  @@index([loadNumber])
  @@index([status])
  @@index([driverId])
  @@index([truckId])
  @@index([actualDeliveryDate])
  @@index([scheduledDeliveryDate])
}

model LoadStop {
  id     String @id @default(cuid())
  loadId String
  load   Load   @relation(fields: [loadId], references: [id], onDelete: Cascade)

  type     LoadStopType
  sequence Int

  address String
  city    String
  state   String
  zip     String
  latitude  Float?
  longitude Float?

  contactName  String?
  contactPhone String?
  items        String? @db.Text

  scheduledDate DateTime?
  actualDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loadId])
  @@index([type])
  @@index([sequence])
}

model LoadCargoItem {
  id     String @id @default(cuid())
  loadId String
  load   Load   @relation(fields: [loadId], references: [id], onDelete: Cascade)

  pickupStopSequence Int?

  name        String? @db.Text
  quantity    Float?
  unit        String?
  weightKg    Float?
  volumeLiters Float?
  volumeM3    Float?
  pallets     Int?
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loadId])
  @@index([pickupStopSequence])
}

model SchengenDay {
  id       String   @id @default(cuid())
  driverId String
  driver   Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  date        DateTime
  inSchengen  Boolean @default(false)
  positionCount Int?  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([driverId, date])
  @@index([driverId])
  @@index([date])
}

model Vehicle {
  id     String @id @default(cuid())
  loadId String
  load   Load   @relation(fields: [loadId], references: [id], onDelete: Cascade)
  pickupStopSequence Int?

  // Vehicle Info
  vin   String
  make  String
  model String
  year  Int
  color String?
  size  VehicleSize

  // Condition
  isOperable  Boolean @default(true)
  damageNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loadId])
  @@index([pickupStopSequence])
}

model Document {
  id String @id @default(cuid())

  // Document Info
  type     DocumentType
  fileName String
  filePath String
  fileSize Int
  mimeType String

  // Expiry (for compliance docs)
  expiryDate DateTime?

  // Associations
  loadId String?
  load   Load?   @relation(fields: [loadId], references: [id], onDelete: Cascade)

  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id], onDelete: Cascade)

  inspectionId String?
  inspection   Inspection? @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  incidentId String?
  incident   Incident? @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  uploadedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([loadId])
  @@index([driverId])
  @@index([inspectionId])
  @@index([incidentId])
}

model PayStub {
  id         String @id @default(cuid())
  stubNumber String @unique

  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Calculations
  totalMiles     Int
  totalAmount    Float
  avgRatePerMile Float

  // Payment
  isPaid   Boolean   @default(false)
  paidDate DateTime?

  // PDF
  pdfPath String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([isPaid])
}

model MaintenanceRecord {
  id String @id @default(cuid())

  truckId String
  truck   Truck  @relation(fields: [truckId], references: [id], onDelete: Cascade)

  type        MaintenanceType
  description String          @db.Text

  performedDate    DateTime
  mileageAtService Int
  nextServiceDue   Int? // mileage

  cost Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([truckId])
}

model TruckExpense {
  id String @id @default(cuid())

  truckId String
  truck   Truck  @relation(fields: [truckId], references: [id], onDelete: Cascade)

  type        ExpenseType
  description String
  amount      Float
  date        DateTime

  // Receipt
  receiptPath String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([truckId])
  @@index([type])
}

model VacationPeriod {
  id String @id @default(cuid())

  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  type      String // VACATION or SICK_LEAVE
  notes     String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

model AuditLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   AuditAction
  entity   AuditEntity
  entityId String

  changes   Json? // before/after object
  ipAddress String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
}

model AlertAcknowledgement {
  id String @id @default(cuid())

  alertId String @unique

  acknowledgedAt  DateTime @default(now())
  acknowledgedById String?
  acknowledgedBy  User?     @relation("AlertAcknowledgements", fields: [acknowledgedById], references: [id], onDelete: SetNull)

  @@index([acknowledgedAt])
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model RecurringLoadTemplate {
  id               String @id @default(cuid())
  recurringGroupId String @unique

  // Same fields as Load for template
  pickupAddress      String
  pickupCity         String
  pickupState        String
  pickupZip          String
  pickupContactName  String
  pickupContactPhone String

  deliveryAddress      String
  deliveryCity         String
  deliveryState        String
  deliveryZip          String
  deliveryContactName  String
  deliveryContactPhone String

  distance          Int
  deadheadMiles     Int    @default(0)
  loadRate          Float
  customRatePerMile Float?
  detentionTime     Int?
  detentionPay      Float? @default(0)

  notes               String? @db.Text
  specialInstructions String? @db.Text

  // Recurring Configuration
  frequency  RecurringFrequency
  dayOfWeek  Int? // 0-6 for weekly (0 = Sunday)
  dayOfMonth Int? // 1-31 for monthly
  isActive   Boolean            @default(true)

  // Assignment (optional default)
  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  truckId String?
  truck   Truck?  @relation(fields: [truckId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastGeneratedAt DateTime?

  @@index([recurringGroupId])
  @@index([frequency])
  @@index([isActive])
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

// Traccar Position History
model Position {
  id String @id @default(cuid())

  // Device Reference
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)
  deviceId String // Traccar Device ID (e.g., KAMION-01)

  // Location Data
  latitude  Float
  longitude Float
  altitude  Float?
  speed     Float? @default(0) // km/h
  bearing   Float? // Direction in degrees (0-360)
  accuracy  Float? // Accuracy in meters

  // Device Status
  battery Float? // Battery level 0-100

  // Timestamp
  recordedAt DateTime @default(now()) // When position was recorded by device
  receivedAt DateTime @default(now()) // When server received the data

  @@index([driverId])
  @@index([deviceId])
  @@index([recordedAt])
  @@index([driverId, recordedAt])
}

// Geofencing Zones
model Zone {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Geographic area (circular zone)
  centerLat Float
  centerLon Float
  radius    Int // meters

  // Zone type and settings
  type     ZoneType @default(CUSTOM)
  isActive Boolean  @default(true)

  // Notification settings
  notifyOnEntry Boolean @default(true)
  notifyOnExit  Boolean @default(true)

  // Associated load/location (optional)
  loadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events GeofenceEvent[]

  @@index([type])
  @@index([isActive])
  @@index([loadId])
}

enum ZoneType {
  PICKUP // Pickup location zone
  DELIVERY // Delivery location zone
  DEPOT // Company depot/yard
  REST_AREA // Rest area
  BORDER_CROSSING // Border crossing point
  CUSTOM // Custom user-defined zone
}

// Geofence Events (entry/exit tracking)
model GeofenceEvent {
  id String @id @default(cuid())

  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  eventType  GeofenceEventType
  latitude   Float
  longitude  Float
  speed      Float?
  detectedAt DateTime          @default(now())

  // Notification status
  notificationSent Boolean @default(false)

  @@index([zoneId])
  @@index([driverId])
  @@index([detectedAt])
  @@index([driverId, detectedAt])
}

enum GeofenceEventType {
  ENTRY
  EXIT
}
